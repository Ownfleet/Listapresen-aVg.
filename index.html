<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Presen√ßa ‚Ä¢ Motorista</title>

  <!-- Firebase CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /************* üîß CONFIGURA√á√ïES *************/
    const RAIO_METROS = 200;
    const BASE_LAT = -23.443930639321323;
    const BASE_LON = -46.52911457443008;

    // üëâ COLE AQUI SEU firebaseConfig
     const firebaseConfig = {
    apiKey: "AIzaSyCiW72I3-AGGVLhxWcCca_5fpvA9ebV8Yk",
    authDomain: "presenca-motoristas-vg.firebaseapp.com",
    projectId: "presenca-motoristas-vg",
    storageBucket: "presenca-motoristas-vg.firebasestorage.app",
    messagingSenderId: "826408940490",
    appId: "1:826408940490:web:6884682bf474ca6eec1533",
    measurementId: "G-SEGE1SVEWM"
    };
    /*******************************************/

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const $ = id => document.getElementById(id);

    let watchId = null;
    let ultimaPosicao = null;
    let gpsValido = false;

    /************* üìç DIST√ÇNCIA (HAVERSINE) *************/
    function distancia(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) ** 2 +
        Math.cos(lat1 * Math.PI/180) *
        Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) ** 2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    /************* üö´ ANTI GPS FAKE *************/
    function validarGPS(pos) {
      const acc = pos.coords.accuracy;
      if (acc > 50) return false;

      if (ultimaPosicao) {
        const d = distancia(
          ultimaPosicao.lat, ultimaPosicao.lon,
          pos.coords.latitude, pos.coords.longitude
        );
        const dt = (pos.timestamp - ultimaPosicao.time) / 1000;
        if (dt > 0 && (d / dt) > 50) return false; // teleport
      }

      ultimaPosicao = {
        lat: pos.coords.latitude,
        lon: pos.coords.longitude,
        time: pos.timestamp
      };

      return true;
    }

    /************* üìç MONITORAR LOCALIZA√á√ÉO *************/
    function iniciarGPS() {
      if (!navigator.geolocation) {
        alert("Seu navegador n√£o suporta localiza√ß√£o.");
        return;
      }

      watchId = navigator.geolocation.watchPosition(
        pos => {
          if (!validarGPS(pos)) {
            gpsValido = false;
            $("status").innerText = "‚ùå Localiza√ß√£o inv√°lida (GPS suspeito)";
            $("btnPresenca").disabled = true;
            return;
          }

          const d = distancia(
            BASE_LAT, BASE_LON,
            pos.coords.latitude, pos.coords.longitude
          );

          if (d <= RAIO_METROS) {
            gpsValido = true;
            $("status").innerText = "üü¢ Dentro da √°rea";
            $("btnPresenca").disabled = false;
          } else {
            gpsValido = false;
            $("status").innerText = "üî¥ Fora da √°rea permitida";
            $("btnPresenca").disabled = true;
          }
        },
        err => {
          alert("Permita a localiza√ß√£o para continuar.");
          $("btnPresenca").disabled = true;
        },
        { enableHighAccuracy: true, maximumAge: 0 }
      );
    }

    /************* üîê LOGIN *************/
    $("login").onclick = async () => {
      await signInWithPopup(auth, provider);
    };

    onAuthStateChanged(auth, async user => {
      if (!user) return;
      $("loginBox").style.display = "none";
      $("app").style.display = "block";

      iniciarGPS();

      const ref = doc(db, "motoristas", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        $("cadastro").style.display = "block";
      } else {
        $("cadastro").style.display = "none";
      }
    });

    /************* üßæ CADASTRO 1¬™ VEZ *************/
    $("salvarCadastro").onclick = async () => {
      const user = auth.currentUser;
      await setDoc(doc(db, "motoristas", user.uid), {
        driver_id: $("driver_id").value,
        nome: $("nome").value,
        telefone: $("telefone").value,
        tipo_veiculo: $("veiculo").value,
        placa: $("placa").value,
        criado_em: serverTimestamp()
      });
      alert("Cadastro salvo.");
      $("cadastro").style.display = "none";
    };

    /************* üõ£Ô∏è ROTA COM TRA√áO *************/
    $("rota").oninput = e => {
      let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
      if (v.length > 1) v = v[0] + "-" + v.slice(1);
      e.target.value = v;
    };

    /************* ‚úÖ REGISTRAR PRESEN√áA *************/
    $("btnPresenca").onclick = async () => {
      if (!gpsValido) return;

      const user = auth.currentUser;
      const hoje = new Date().toISOString().slice(0,10);

      await addDoc(collection(db, "presencas"), {
        uid: user.uid,
        turno: $("turno").value,
        rota: $("rota").value,
        data_dia: hoje,
        hora: new Date().toLocaleTimeString("pt-BR"),
        registrado_em: serverTimestamp()
      });

      alert("Presen√ßa registrada com sucesso.");
    };
  </script>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
    .box { max-width:420px; margin:auto; padding:20px; }
    button, input, select {
      width:100%; padding:12px; margin:6px 0; font-size:16px;
    }
    button { background:#ff5722; color:#fff; border:none; border-radius:6px; }
    button:disabled { background:#ccc; }
    .card { background:#fff; padding:16px; border-radius:8px; }
    #app { display:none; }
  </style>
</head>

<body>
  <div class="box">

    <div id="loginBox" class="card">
      <button id="login">Entrar com Google</button>
    </div>

    <div id="app">
      <p id="status">Aguardando GPS‚Ä¶</p>

      <div id="cadastro" class="card" style="display:none">
        <input id="driver_id" placeholder="ID do motorista" />
        <input id="nome" placeholder="Nome" />
        <input id="telefone" placeholder="Telefone" />
        <select id="veiculo">
          <option>FIORINO</option>
          <option>PASSEIO</option>
          <option>VAN</option>
          <option>MOTO</option>
        </select>
        <input id="placa" placeholder="Placa" />
        <button id="salvarCadastro">Salvar cadastro</button>
      </div>

      <div class="card">
        <select id="turno">
          <option>AM</option>
          <option>SD</option>
        </select>
        <input id="rota" placeholder="Rota (ex: A-12)" />
        <button id="btnPresenca" disabled>Registrar Presen√ßa</button>
      </div>
    </div>

  </div>
</body>
</html>
