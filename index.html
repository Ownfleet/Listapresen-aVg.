<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Lista de Presen√ßa ‚Ä¢ HUB LSP-18 VG</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#ee4d2d;--brand2:#ff6b3d;--bg:#0b0f19;
  --card:rgba(255,255,255,.08);--line:rgba(255,255,255,.15);
  --radius:22px;--ink:#f1f5f9;--muted:#9fb0c0;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Plus Jakarta Sans",system-ui,Arial;
  background:linear-gradient(145deg,#0b0f19,#111b2a);
  color:var(--ink);
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;padding:0 18px;
}

/* ===== Header ===== */
header{
  position:fixed;top:0;width:100%;text-align:center;
  background:linear-gradient(90deg,var(--brand),var(--brand2),var(--brand));
  color:#fff;padding:16px;font-weight:800;font-size:1.3rem;
  box-shadow:0 10px 30px rgba(238,77,45,.3);
  animation:bar 8s linear infinite;background-size:200% 100%;
}
@keyframes bar{0%{background-position:0 0}100%{background-position:200% 0}}

.container{
  width:min(960px,96vw);
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:0 40px 90px rgba(238,77,45,.25);
  padding:28px;margin-top:80px;
  backdrop-filter:blur(12px);
}

/* ===== Mapa ===== */
#map{height:320px;border-radius:18px;margin-bottom:16px;overflow:hidden}
.chip{
  display:inline-block;padding:10px 14px;border-radius:999px;
  border:1px dashed rgba(255,255,255,.25);
  font-weight:700;font-size:.95rem;margin-bottom:12px;
}
.ok{color:#10b981;background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.4);}
.bad{color:#f87171;background:rgba(248,113,113,.15);border-color:rgba(248,113,113,.4);}

/* ===== Inputs ===== */
label{font-weight:700;display:block;margin:8px 4px 6px;}
input,select{
  width:100%;padding:16px 14px;border-radius:16px;
  background:rgba(255,255,255,.08);border:1.8px solid var(--line);
  color:#fff;font:inherit;
}
input:focus,select:focus{border-color:var(--brand2);outline:none;box-shadow:0 0 0 3px rgba(255,107,61,.25)}
.grid{display:grid;gap:12px}
@media(min-width:700px){.grid.two{grid-template-columns:1fr 1fr}}

/* ===== Bot√µes ===== */
.actions{display:flex;justify-content:flex-end;gap:12px;margin-top:18px;}
.btn{
  padding:16px 22px;border:0;border-radius:16px;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  color:#fff;font-weight:800;cursor:pointer;
  box-shadow:0 20px 50px rgba(238,77,45,.25);
  transition:.2s transform;
}
.btn:hover{transform:translateY(-2px)}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* ===== Footer ===== */
footer{text-align:center;margin-top:26px;color:#9fb0c0;font-size:.9rem}
footer span{color:#ffbea9}
</style>
</head>
<body>

<header>Lista de Presen√ßa ‚Ä¢ HUB LSP‚Äì18 VG</header>

<!-- Modal GPS -->
<div class="container" id="gpsCard">
  <h2>Status de Localiza√ß√£o</h2>
  <p>O sistema verifica sua posi√ß√£o ‚Äî voc√™ s√≥ pode continuar dentro do raio autorizado.</p>
  <div id="map"></div>
  <div id="statusChip" class="chip bad">Aguardando localiza√ß√£o...</div>
  <p>Dist√¢ncia at√© o HUB: <b id="distance">‚Äì</b> m</p>
  <div class="actions">
    <button class="btn" id="continueBtn" disabled>Continuar</button>
  </div>
</div>

<!-- Modal Form -->
<div class="container" id="formCard" style="display:none">
  <h2>Registrar Presen√ßa</h2>
  <p>Preencha os dados abaixo:</p>

  <div class="grid two">
    <div><label>ID do Motorista</label><input id="driver_id"></div>
    <div><label>Placa</label><input id="plate" placeholder="ABC1D23"></div>
    <div><label>Nome Completo</label><input id="name"></div>
    <div><label>Ve√≠culo</label>
      <select id="vehicle"><option value="">Selecione...</option><option>Moto</option><option>Passeio</option><option>Fiorino</option></select>
    </div>
    <div><label>Letra‚ÄìN√∫mero da Rota</label><input id="assignment_code" maxlength="4" placeholder="A-12"></div>
    <div><label>Turno</label><select id="turno"><option>AM</option><option>SD</option></select></div>
  </div>

  <div class="actions">
    <button class="btn" id="submitBtn">Registrar ‚úÖ</button>
  </div>
</div>

<footer>¬© HUB LSP‚Äì18 VG ‚Ä¢ Sistema de presen√ßa com geofence ativo<br><span>by Create Richard LSP-12</span></footer>

<script>
const hub = {lat:-23.443930639321323, lon:-46.52911457443008, radius_m:250};
let coord=null, inside=false;
const chip=document.getElementById("statusChip");
const distEl=document.getElementById("distance");
const continueBtn=document.getElementById("continueBtn");
const gpsCard=document.getElementById("gpsCard");
const formCard=document.getElementById("formCard");

const map=L.map("map",{zoomControl:false}).setView([hub.lat,hub.lon],18);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
L.marker([hub.lat,hub.lon]).addTo(map).bindPopup("üìç HUB LSP‚Äì18 VG");
L.circle([hub.lat,hub.lon],{radius:hub.radius_m,color:"#ff6b3d",fillColor:"#ff6b3d",fillOpacity:0.25}).addTo(map);
let userMarker=null;

function toRad(v){return v*Math.PI/180;}
function dist(lat1,lon1,lat2,lon2){
  const R=6371000;const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* --- Monitora continuamente --- */
function monitorGPS(){
  if(!navigator.geolocation){
    chip.textContent="‚ùå GPS n√£o suportado";chip.className="chip bad";return;
  }
  navigator.geolocation.watchPosition(pos=>{
    coord=pos.coords;
    const d=dist(coord.latitude,coord.longitude,hub.lat,hub.lon);
    distEl.textContent=d.toFixed(1);
    if(userMarker) map.removeLayer(userMarker);
    userMarker=L.marker([coord.latitude,coord.longitude]).addTo(map);

    const insideNow=d<=hub.radius_m;
    if(insideNow){
      chip.textContent="‚úÖ Dentro do Raio";
      chip.className="chip ok";
      continueBtn.disabled=false;
    }else{
      chip.textContent="‚ö†Ô∏è Fora do Raio";
      chip.className="chip bad";
      continueBtn.disabled=true;
      // Se ele sair do raio e o form estiver aberto, bloqueia de novo:
      if(formCard.style.display==="block"){
        alert("Voc√™ saiu do raio do HUB. O formul√°rio foi bloqueado at√© retornar √† √°rea permitida.");
        formCard.style.display="none";
        gpsCard.style.display="block";
      }
    }
  },()=>{chip.textContent="‚ùå Permita o GPS";chip.className="chip bad";continueBtn.disabled=true;},{enableHighAccuracy:true});
}

continueBtn.onclick=()=>{
  gpsCard.style.display="none";
  formCard.style.display="block";
};

monitorGPS();

document.getElementById("submitBtn").onclick=()=>{
  const dados={
    driver_id:document.getElementById("driver_id").value.trim(),
    name:document.getElementById("name").value.trim(),
    vehicle:document.getElementById("vehicle").value,
    plate:document.getElementById("plate").value.trim().toUpperCase(),
    assignment_code:document.getElementById("assignment_code").value.trim(),
    turno:document.getElementById("turno").value,
    lat:coord?.latitude, lon:coord?.longitude
  };
  for(const[k,v]of Object.entries(dados)) if(!v){alert("Preencha todos os campos.");return;}
  document.getElementById("submitBtn").disabled=true;
  google.script.run.withSuccessHandler(r=>{
    document.getElementById("submitBtn").disabled=false;
    if(r.ok){alert("‚úÖ Presen√ßa registrada com sucesso!");location.reload();}
    else alert("Erro: "+r.error);
  }).withFailureHandler(e=>{
    alert("Falha: "+e.message);
    document.getElementById("submitBtn").disabled=false;
  }).salvarPresenca(dados);
};
</script>
</body>
</html>
