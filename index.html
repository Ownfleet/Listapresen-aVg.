<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lista de Presença • HUB LSP-18 VG</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#ee4d2d;--brand2:#ff6b3d;--ink:#0f172a;--muted:#9ca3af;
  --bg:#0b0f19;--glass:rgba(255,255,255,.12);
  --neon:0 0 12px #ff6b3d, 0 0 32px #ff6b3d;
  --radius:18px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Plus Jakarta Sans",system-ui,Arial;
  background:radial-gradient(900px 600px at 70% -20%,rgba(255,107,61,.15) 0,transparent 70%),linear-gradient(145deg,#0a0e1a,#141d26);
  color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;
}
header{
  position:fixed;top:0;left:0;right:0;text-align:center;
  background:linear-gradient(90deg,#ee4d2d,#ff6b3d,#ee4d2d);
  padding:14px;font-weight:800;letter-spacing:.5px;
  color:#fff;text-shadow:0 0 10px rgba(255,255,255,.4);
  box-shadow:0 0 18px rgba(238,77,45,.4);
}
footer{
  position:fixed;bottom:8px;width:100%;text-align:center;font-size:12px;color:#aaa;
}
.modal-backdrop{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.65);backdrop-filter:blur(10px);z-index:100;
}
.modal{
  width:min(92vw,520px);
  background:var(--glass);
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,.08);
  padding:26px;
  box-shadow:0 0 30px rgba(238,77,45,.25),inset 0 0 12px rgba(255,255,255,.06);
  animation:fadeIn .4s ease-out both;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
h2{margin-bottom:6px;color:#fff;font-weight:800;text-shadow:var(--neon);}
.sub{color:#cbd5e1;font-size:13px;margin-bottom:14px}
.kpi{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08)}
.btn{
  padding:12px 18px;border:0;border-radius:var(--radius);font-weight:800;
  background:linear-gradient(135deg,#ff6b3d,#ee4d2d);
  color:#fff;cursor:pointer;
  box-shadow:0 0 12px rgba(238,77,45,.4);transition:.2s;
}
.btn:hover{transform:translateY(-2px);box-shadow:0 0 20px rgba(255,107,61,.6)}
.btn-ghost{
  background:rgba(255,255,255,.05);color:#ff6b3d;
  border:1.5px solid rgba(255,107,61,.4);
}
.btn-ghost:hover{background:rgba(255,107,61,.15);}
.chip{
  padding:8px 12px;border-radius:999px;font-weight:800;font-size:13px;
  border:1px dashed rgba(255,255,255,.2);text-transform:uppercase;letter-spacing:.5px;
}
.ok{color:#10b981;background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.3)}
.bad{color:#f87171;background:rgba(248,113,113,.15);border-color:rgba(248,113,113,.3)}
#map{height:220px;margin:10px 0;border-radius:14px;overflow:hidden}
input,select{
  width:100%;padding:12px 14px;margin-top:10px;
  border:1.6px solid rgba(255,255,255,.1);border-radius:14px;
  background:rgba(255,255,255,.05);color:#fff;
  font:inherit;transition:border .2s,box-shadow .2s;
}
input:focus,select:focus{border-color:#ff6b3d;box-shadow:0 0 0 3px rgba(255,107,61,.3);outline:none}
label{font-weight:700;font-size:13px;margin-top:12px;display:block;color:#e2e8f0}
.actions{display:flex;justify-content:flex-end;gap:10px;margin-top:18px}
.success{text-align:center;padding:30px}
.success .check{
  width:90px;height:90px;margin:0 auto 12px;
  background:linear-gradient(135deg,#16a34a,#22c55e);
  border-radius:50%;font-size:38px;display:grid;place-items:center;
  color:#fff;box-shadow:0 0 20px rgba(16,185,129,.5);
}
.pulsing{animation:pulse 1.4s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.8}50%{opacity:.4}}
</style>
</head>
<body>
<header>Lista de Presença • HUB LSP-18 VG</header>

<!-- MODAL GPS -->
<div id="gpsModal" class="modal-backdrop">
  <div class="modal">
    <h2>Status de Localização</h2>
    <div class="sub">Permita o GPS — só continua quando estiver dentro do raio autorizado.</div>
    <div id="map"></div>
    <div style="margin:14px 0"><span id="statusChip" class="chip pulsing">Aguardando GPS...</span></div>
    <div class="kpi"><span>Distância do HUB</span><span id="distance">–</span> m</div>
    <div class="kpi"><span>Raio permitido</span><span id="radius">250</span> m</div>
    <div class="actions">
      <button id="recalibrateBtn" class="btn-ghost">📡 Calibrar</button>
      <button id="continueBtn" class="btn" disabled>Continuar</button>
    </div>
  </div>
</div>

<!-- MODAL FORM -->
<div id="presenceModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <h2>Registrar Presença</h2>
    <div class="sub">Confirme seus dados para registrar no sistema.</div>

    <label>ID do Motorista</label><input id="driver_id" placeholder="Ex: 000123">
    <label>Nome Completo</label><input id="name">
    <label>Veículo</label>
    <select id="vehicle"><option value="">Selecione...</option><option>Moto</option><option>Passeio</option><option>Fiorino</option><option>Van</option><option>Outro</option></select>
    <label>Placa</label><input id="plate" placeholder="ABC1D23">
    <label>Turno</label><select id="shift"><option value="">Selecione...</option><option>AM</option><option>SD</option></select>
    <label>Letra–Número da Rota</label><input id="assignment_code" maxlength="4" placeholder="A-12">
    <label>Turno da Rota</label><select id="turno"><option value="">Selecione...</option><option>AM</option><option>SD</option></select>

    <div class="actions">
      <button id="backBtn" class="btn-ghost">Voltar</button>
      <button id="submitBtn" class="btn">Registrar ✅</button>
    </div>
  </div>
</div>

<!-- MODAL SUCESSO -->
<div id="successModal" class="modal-backdrop" style="display:none">
  <div class="modal success">
    <div class="check">✓</div>
    <h2>Presença registrada!</h2>
    <p id="successInfo" class="sub"></p>
    <button id="closeSuccess" class="btn">Fechar</button>
  </div>
</div>

<footer>© HUB LSP-18 VG • Sistema de presença com geofence ativo</footer>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzE7CWdCriIWLuwIw1I1jqT8ysbpO-jMeGCtaNXTm8SLUL7X0xp2fRPgT65JsaUOJhC/exec';
const hub = { lat:-23.443930639321323, lon:-46.52911457443008, radius_m:250 };

const map = L.map("map",{zoomControl:false}).setView([hub.lat,hub.lon],18);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
L.marker([hub.lat,hub.lon]).addTo(map).bindPopup("📍 HUB LSP-18 VG");
L.circle([hub.lat,hub.lon],{radius:hub.radius_m,color:"#ff6b3d",fillColor:"#ff6b3d",fillOpacity:0.25}).addTo(map);

const gpsModal=document.getElementById("gpsModal"),presenceModal=document.getElementById("presenceModal"),successModal=document.getElementById("successModal");
const statusChip=document.getElementById("statusChip"),distanceEl=document.getElementById("distance"),cont=document.getElementById("continueBtn");
const driver_id=document.getElementById("driver_id"),nameEl=document.getElementById("name"),vehicle=document.getElementById("vehicle"),plate=document.getElementById("plate"),shift=document.getElementById("shift"),assignment_code=document.getElementById("assignment_code"),turno=document.getElementById("turno"),submitBtn=document.getElementById("submitBtn"),successInfo=document.getElementById("successInfo");

let coord=null,userMarker=null;
function toRad(v){return v*Math.PI/180;}
function dist(lat1,lon1,lat2,lon2){const R=6371000;const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function setChip(t,c=""){statusChip.textContent=t;statusChip.className="chip "+c;}

function monitorGPS(){
  if(!navigator.geolocation){setChip("GPS não suportado","bad");return;}
  setChip("Obtendo GPS...","pulsing");
  navigator.geolocation.watchPosition(pos=>{
    coord=pos.coords;
    const d=dist(coord.latitude,coord.longitude,hub.lat,hub.lon);
    distanceEl.textContent=d.toFixed(1);
    if(userMarker) map.removeLayer(userMarker);
    userMarker=L.marker([coord.latitude,coord.longitude]).addTo(map);
    const dentro=d<=hub.radius_m;
    setChip(dentro?"✅ DENTRO DO RAIO":"⚠️ FORA DO RAIO", dentro?"ok":"bad");
    cont.disabled=!dentro;
  },()=>{setChip("Permita a localização","bad");cont.disabled=true;},{enableHighAccuracy:true});
}

window.addEventListener("load",monitorGPS);
document.getElementById("recalibrateBtn").onclick=monitorGPS;
cont.onclick=()=>{gpsModal.style.display="none";presenceModal.style.display="flex";};
document.getElementById("backBtn").onclick=()=>{presenceModal.style.display="none";gpsModal.style.display="flex";monitorGPS();};

assignment_code.addEventListener("input",()=>{let val=assignment_code.value.toUpperCase().replace(/[^A-Z0-9]/g,"");if(val.length>1&&!val.includes("-"))val=val[0]+"-"+val.slice(1);assignment_code.value=val;});

submitBtn.onclick=async()=>{
  if(!coord){alert("Sem coordenadas válidas.");return;}
  const d=dist(coord.latitude,coord.longitude,hub.lat,hub.lon);
  if(d>hub.radius_m){alert("Você está fora da região do HUB.");return;}

  const payload={driver_id:driver_id.value.trim(),name:nameEl.value.trim(),vehicle:vehicle.value,plate:plate.value.trim().toUpperCase(),shift:shift.value,assignment_code:assignment_code.value.trim(),turno:turno.value,lat:coord.latitude,lon:coord.longitude};
  for(const [k,v]of Object.entries(payload))if(!v){alert("Preencha todos os campos.");return;}

  submitBtn.disabled=true;
  try{
    const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const json=await res.json();
    if(!json.ok)throw new Error(json.error||'Falha ao registrar');
    presenceModal.style.display="none";successModal.style.display="flex";
    successInfo.innerHTML=`Rota <b>${payload.assignment_code}</b> • Turno ${payload.turno} • Dist.: ${json.distance_m} m`;
  }catch(err){alert('Erro: '+err.message);}
  finally{submitBtn.disabled=false;}
};
document.getElementById("closeSuccess").onclick=()=>{successModal.style.display="none";gpsModal.style.display="flex";monitorGPS();};
</script>
</body>
</html>

