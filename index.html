<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lista de Presen√ßa ‚Ä¢ HUB LSP-18 VG</title>

<!-- Fonts & Libs -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --brand:#ee4d2d;--brand2:#ff6b3d;--ink:#0f172a;--muted:#6b7280;
  --glass:rgba(255,255,255,.86);--radius:20px;
  --shadow:0 30px 80px rgba(238,77,45,.22),0 10px 24px rgba(15,23,42,.06);
}
*{box-sizing:border-box}
body{
  margin:0;font-family:"Plus Jakarta Sans",system-ui,Arial;color:var(--ink);
  background:radial-gradient(1000px 600px at 80% -10%,#ffd9ce 0,transparent 60%),linear-gradient(145deg,#fff7f5,#ffe6de);
  min-height:100vh;overflow:hidden;
}
header{
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  color:#fff;text-align:center;padding:18px;font-weight:800;letter-spacing:.3px;
  box-shadow:0 8px 20px rgba(238,77,45,.25);
}
footer{text-align:center;padding:10px;font-size:12px;color:var(--muted)}
.modal-backdrop{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(70vw 70vh at 50% -10%,rgba(238,77,45,.2),transparent 60%),rgba(15,23,42,.25);
  backdrop-filter:blur(6px);z-index:100;
}
.modal{
  width:min(94vw,600px);background:var(--glass);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:24px;animation:fadeIn .3s ease-out both;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
h2{margin:0 0 8px;color:var(--brand);font-weight:800}
.sub{color:var(--muted);font-size:13px;margin-bottom:12px}
.kpi{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f1f1f1}
.btn{
  padding:12px 18px;border:0;border-radius:14px;font-weight:800;cursor:pointer;
  background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;
  box-shadow:0 10px 20px rgba(238,77,45,.25);transition:.15s;
}
.btn:hover{transform:translateY(-1px);box-shadow:0 14px 26px rgba(238,77,45,.35)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-ghost{background:#fff;color:#c2410c;border:1.5px solid #ffd0c4}
.chip{
  padding:8px 10px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.3px;
  background:#fff1ed;color:#d64a28;border:1px dashed #ffb19b;
}
.ok{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}
#map{height:220px;margin:10px 0;border-radius:14px;overflow:hidden;}
input,select{
  width:100%;padding:12px 14px;border:1.6px solid #e5e7eb;border-radius:14px;font:inherit;background:#fff;
  transition:border .2s,box-shadow .2s;
}
input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px #ffe2d9}
label{font-weight:700;font-size:13px;margin-top:10px;display:block;color:#374151}
.actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px}
.success{text-align:center;padding:30px}
.success .check{
  width:90px;height:90px;margin:0 auto 12px;background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#fff;border-radius:50%;font-size:38px;display:grid;place-items:center;
  box-shadow:0 12px 26px rgba(34,197,94,.35);
}
.pulsing{animation:pulse 1.4s ease-in-out infinite}
@keyframes pulse{0%{opacity:.8}50%{opacity:.4}100%{opacity:.8}}
</style>
</head>
<body>
<header>Lista de Presen√ßa ‚Ä¢ HUB LSP-18 VG</header>

<!-- MODAL 1: GPS -->
<div id="gpsModal" class="modal-backdrop">
  <div class="modal">
    <h2>Status de Localiza√ß√£o</h2>
    <div class="sub">Permita o GPS. S√≥ continua quando estiver dentro do raio.</div>
    <div id="map"></div>

    <div style="margin:14px 0"><span id="statusChip" class="chip pulsing">Aguardando GPS...</span></div>
    <div class="kpi"><span>Dist√¢ncia do HUB</span><span id="distance">‚Äì</span> m</div>
    <div class="kpi"><span>Raio permitido</span><span id="radius">250</span> m</div>

    <div class="actions">
      <button id="recalibrateBtn" class="btn-ghost">üìç Calibrar GPS</button>
      <button id="continueBtn" class="btn" disabled>Continuar</button>
    </div>
  </div>
</div>

<!-- MODAL 2: PRESEN√áA -->
<div id="presenceModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <h2>Registrar Presen√ßa</h2>
    <div class="sub">Preencha seus dados corretamente.</div>

    <label>ID do Motorista</label><input id="driver_id" placeholder="Ex: 000123">
    <label>Nome Completo</label><input id="name">
    <label>Ve√≠culo</label>
    <select id="vehicle">
      <option value="">Selecione...</option>
      <option>Moto</option><option>Passeio</option><option>Fiorino</option><option>Van</option><option>Outro</option>
    </select>
    <label>Placa</label><input id="plate" placeholder="ABC1D23">
    <label>Turno</label><select id="shift"><option value="">Selecione...</option><option>AM</option><option>SD</option></select>
    <label>Letra‚ÄìN√∫mero da Rota</label><input id="assignment_code" placeholder="A-12">
    <label>Turno da Rota</label><select id="turno"><option value="">Selecione...</option><option>AM</option><option>SD</option></select>

    <div class="actions">
      <button id="backBtn" class="btn-ghost">Voltar</button>
      <button id="submitBtn" class="btn">Registrar Presen√ßa ‚úÖ</button>
    </div>
  </div>
</div>

<!-- MODAL 3: SUCESSO -->
<div id="successModal" class="modal-backdrop" style="display:none">
  <div class="modal success">
    <div class="check">‚úì</div>
    <h2 style="color:#065f46">Presen√ßa registrada!</h2>
    <p id="successInfo" class="sub"></p>
    <button id="closeSuccess" class="btn">Fechar</button>
  </div>
</div>

<footer>¬© HUB LSP-18 VG ‚Ä¢ Geofence ativo</footer>

<script>
const SUPABASE_URL="https://rtuxwydhgucdqbmyuhbt.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0dXh3eWRoZ3VjZHFibXl1aGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTQyOTEsImV4cCI6MjA3NTM5MDI5MX0._69KQdPbipke-jVmF_UEO3VAYaiEqpa1h81jUVTN684";
const client=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const hub={lat:-23.422724170975744, lon:-46.523055269024475, radius_m:250};

// ELEMENTOS
const gpsModal=document.getElementById("gpsModal"),
      presenceModal=document.getElementById("presenceModal"),
      successModal=document.getElementById("successModal");
const statusChip=document.getElementById("statusChip"),
      distanceEl=document.getElementById("distance"),
      recal=document.getElementById("recalibrateBtn"),
      cont=document.getElementById("continueBtn");
const driver_id=document.getElementById("driver_id"),
      nameEl=document.getElementById("name"),
      vehicle=document.getElementById("vehicle"),
      plate=document.getElementById("plate"),
      shift=document.getElementById("shift"),
      assignment_code=document.getElementById("assignment_code"),
      turno=document.getElementById("turno"),
      submitBtn=document.getElementById("submitBtn"),
      backBtn=document.getElementById("backBtn"),
      successInfo=document.getElementById("successInfo"),
      closeSuccess=document.getElementById("closeSuccess");

let coord=null; radius.textContent=hub.radius_m;

// MAPA
const map=L.map("map",{zoomControl:false}).setView([hub.lat,hub.lon],18);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);
const hubMarker=L.marker([hub.lat,hub.lon]).addTo(map).bindPopup("üìç HUB LSP-18 VG");
const circle=L.circle([hub.lat,hub.lon],{radius:hub.radius_m,color:"#ee4d2d",fillColor:"#ff7b56",fillOpacity:0.25}).addTo(map);
let userMarker=null;

function toRad(v){return v*Math.PI/180;}
function dist(lat1,lon1,lat2,lon2){
  const R=6371000;
  const œÜ1=toRad(lat1),œÜ2=toRad(lat2);
  const ŒîœÜ=toRad(lat2-lat1),ŒîŒª=toRad(lon2-lon1);
  const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}
function setChip(t,c=""){statusChip.textContent=t;statusChip.className="chip "+c;}

function monitorGPS(){
  if(!navigator.geolocation){setChip("GPS n√£o suportado","bad");return;}
  setChip("Obtendo GPS...","pulsing");
  navigator.geolocation.watchPosition(
    pos=>{
      coord=pos.coords;
      const d=dist(coord.latitude,coord.longitude,hub.lat,hub.lon);
      distanceEl.textContent=d.toFixed(1);
      if(userMarker)map.removeLayer(userMarker);
      userMarker=L.marker([coord.latitude,coord.longitude],{title:"Voc√™"}).addTo(map);
      map.panTo([coord.latitude,coord.longitude]);
      const dentro=d<=hub.radius_m;
      if(dentro){setChip("‚úÖ DENTRO DO RAIO","ok");cont.disabled=false;}
      else{setChip("‚ö†Ô∏è FORA DO RAIO","bad");cont.disabled=true;}
    },
    err=>{
      console.warn("Erro GPS:",err);
      setChip("Permita a localiza√ß√£o","bad");
      cont.disabled=true;
    },
    {enableHighAccuracy:true,maximumAge:0,timeout:15000}
  );
}

window.addEventListener("load",monitorGPS);
recal.onclick=monitorGPS;
cont.onclick=()=>{gpsModal.style.display="none";presenceModal.style.display="flex";};
backBtn.onclick=()=>{presenceModal.style.display="none";gpsModal.style.display="flex";monitorGPS();};

submitBtn.onclick=async()=>{
  if(!coord){alert("Sem coordenadas v√°lidas.");return;}
  const d=dist(coord.latitude,coord.longitude,hub.lat,hub.lon);
  if(d>hub.radius_m)return alert("Voc√™ est√° fora da regi√£o do HUB.");

  const payload={
    p_driver_id:driver_id.value.trim(),
    p_name:nameEl.value.trim(),
    p_vehicle:vehicle.value,
    p_plate:plate.value.trim().toUpperCase(),
    p_shift:shift.value,
    p_turno:turno.value
  };
  for(const [k,v] of Object.entries(payload)) if(!v)return alert("Preencha todos os campos.");

  submitBtn.disabled=true;
  const {error}=await client.rpc("log_presence",payload);
  submitBtn.disabled=false;
  if(error)return alert("Erro ao registrar: "+error.message);

  presenceModal.style.display="none";
  successModal.style.display="flex";
  successInfo.innerHTML=`Motorista <b>${payload.p_name}</b> ‚Ä¢ Turno ${payload.p_turno}`;
};

closeSuccess.onclick=()=>{successModal.style.display="none";gpsModal.style.display="flex";monitorGPS();};
</script>
</body>
</html>
